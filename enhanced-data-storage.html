<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Universal Price Tracker - Advanced Data Storage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 700;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 20px;
        }

        .storage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-title {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00ff88;
        }

        .stat-subtitle {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .data-layers {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .layer-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .layer-title {
            font-size: 1.3rem;
            color: #00d4ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .layer-description {
            color: #ccc;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .layer-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .layer-stat {
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            text-align: center;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.3);
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-title {
            color: #00ff88;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .log-entry {
            font-family: monospace;
            font-size: 0.85rem;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #ccc;
        }

        .log-entry.success {
            color: #00ff88;
        }

        .log-entry.warning {
            color: #ffaa00;
        }

        .log-entry.error {
            color: #ff4444;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .pulsing {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Enhanced Price Tracker</h1>
            <p class="subtitle">Advanced Multi-Layer Data Storage System</p>
        </header>

        <div class="storage-stats" id="storageStats">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <div class="data-layers" id="dataLayers">
            <!-- Data layer information will be populated by JavaScript -->
        </div>

        <div class="controls">
            <button class="btn" onclick="startHistoricalDataCollection()">üîÑ Start Historical Collection</button>
            <button class="btn secondary" onclick="compressData()">üóúÔ∏è Compress Data</button>
            <button class="btn secondary" onclick="exportEnhancedData()">üì• Export Data</button>
            <button class="btn secondary" onclick="importData()">üì§ Import Data</button>
            <button class="btn secondary" onclick="analyzeStorage()">üìä Analyze Storage</button>
        </div>

        <div class="log-container">
            <div class="log-title">System Log</div>
            <div id="systemLog">
                <div class="log-entry">System initialized. Enhanced data storage ready.</div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Data Storage System
        class EnhancedDataStorage {
            constructor() {
                this.layers = {
                    recent: 'priceTracker_recent',      // Last 24 hours, full resolution
                    daily: 'priceTracker_daily',        // Last 30 days, hourly averages
                    weekly: 'priceTracker_weekly',      // Last year, daily averages
                    monthly: 'priceTracker_monthly',    // All time, weekly averages
                    compressed: 'priceTracker_compressed' // Compressed historical data
                };
                
                this.compressionRatio = 10; // Compress by factor of 10
                this.maxRecentPoints = 1440; // 24 hours * 60 minutes
                this.maxDailyPoints = 720;   // 30 days * 24 hours
                this.maxWeeklyPoints = 365;  // 365 days
                
                this.initializeStorage();
                this.logAction('Enhanced storage system initialized', 'success');
            }

            initializeStorage() {
                // Initialize each layer if it doesn't exist
                Object.values(this.layers).forEach(key => {
                    if (!localStorage.getItem(key)) {
                        localStorage.setItem(key, JSON.stringify({}));
                    }
                });
            }

            // Add data point with intelligent layering
            addDataPoint(symbol, price, timestamp = Date.now()) {
                const dataPoint = { timestamp, price };
                
                // Add to recent layer (full resolution)
                this.addToLayer('recent', symbol, dataPoint);
                
                // Manage layer sizes and compress old data
                this.manageLayerSizes();
            }

            addToLayer(layerName, symbol, dataPoint) {
                const layerKey = this.layers[layerName];
                const data = JSON.parse(localStorage.getItem(layerKey) || '{}');
                
                if (!data[symbol]) {
                    data[symbol] = [];
                }
                
                data[symbol].push(dataPoint);
                
                try {
                    localStorage.setItem(layerKey, JSON.stringify(data));
                } catch (e) {
                    this.logAction(`Storage full for ${layerName} layer, compressing...`, 'warning');
                    this.compressLayer(layerName);
                }
            }

            // Compress data from one layer to the next
            manageLayerSizes() {
                // Compress recent to daily if too large
                const recentData = JSON.parse(localStorage.getItem(this.layers.recent) || '{}');
                
                Object.keys(recentData).forEach(symbol => {
                    const points = recentData[symbol];
                    
                    if (points && points.length > this.maxRecentPoints) {
                        // Move old data to daily layer as hourly averages
                        const oldPoints = points.slice(0, -this.maxRecentPoints);
                        this.compressToDaily(symbol, oldPoints);
                        
                        // Keep only recent points
                        recentData[symbol] = points.slice(-this.maxRecentPoints);
                    }
                });
                
                localStorage.setItem(this.layers.recent, JSON.stringify(recentData));
            }

            compressToDaily(symbol, points) {
                if (!points || points.length === 0) return;
                
                const dailyData = JSON.parse(localStorage.getItem(this.layers.daily) || '{}');
                if (!dailyData[symbol]) dailyData[symbol] = [];
                
                // Group by hour and average
                const hourlyGroups = {};
                points.forEach(point => {
                    const hourKey = Math.floor(point.timestamp / (1000 * 60 * 60));
                    if (!hourlyGroups[hourKey]) {
                        hourlyGroups[hourKey] = [];
                    }
                    hourlyGroups[hourKey].push(point.price);
                });
                
                // Create hourly averages
                Object.keys(hourlyGroups).forEach(hourKey => {
                    const prices = hourlyGroups[hourKey];
                    const avgPrice = prices.reduce((sum, price) => sum + price, 0) / prices.length;
                    const timestamp = parseInt(hourKey) * 1000 * 60 * 60;
                    
                    dailyData[symbol].push({ timestamp, price: avgPrice });
                });
                
                localStorage.setItem(this.layers.daily, JSON.stringify(dailyData));
                this.logAction(`Compressed ${points.length} points to ${Object.keys(hourlyGroups).length} hourly averages for ${symbol}`, 'success');
            }

            // Get data for a specific time period
            getData(symbol, period) {
                let data = [];
                const now = Date.now();
                let startTime;

                switch (period) {
                    case '1H':
                        startTime = now - (60 * 60 * 1000);
                        data = this.getFromLayer('recent', symbol, startTime);
                        break;
                    case '24H':
                        startTime = now - (24 * 60 * 60 * 1000);
                        data = this.getFromLayer('recent', symbol, startTime);
                        break;
                    case '1W':
                        startTime = now - (7 * 24 * 60 * 60 * 1000);
                        data = [
                            ...this.getFromLayer('recent', symbol, startTime),
                            ...this.getFromLayer('daily', symbol, startTime)
                        ].sort((a, b) => a.timestamp - b.timestamp);
                        break;
                    case '1M':
                        startTime = now - (30 * 24 * 60 * 60 * 1000);
                        data = this.getFromLayer('daily', symbol, startTime);
                        break;
                    case '3M':
                        startTime = now - (90 * 24 * 60 * 60 * 1000);
                        data = [
                            ...this.getFromLayer('daily', symbol, startTime),
                            ...this.getFromLayer('weekly', symbol, startTime)
                        ].sort((a, b) => a.timestamp - b.timestamp);
                        break;
                    case '1Y':
                        startTime = now - (365 * 24 * 60 * 60 * 1000);
                        data = this.getFromLayer('weekly', symbol, startTime);
                        break;
                    case 'ALL':
                        data = [
                            ...this.getFromLayer('recent', symbol, 0),
                            ...this.getFromLayer('daily', symbol, 0),
                            ...this.getFromLayer('weekly', symbol, 0),
                            ...this.getFromLayer('monthly', symbol, 0)
                        ].sort((a, b) => a.timestamp - b.timestamp);
                        break;
                }

                return this.removeDuplicates(data);
            }

            getFromLayer(layerName, symbol, startTime) {
                const layerKey = this.layers[layerName];
                const data = JSON.parse(localStorage.getItem(layerKey) || '{}');
                const symbolData = data[symbol] || [];
                
                return symbolData.filter(point => point.timestamp >= startTime);
            }

            removeDuplicates(data) {
                const seen = new Set();
                return data.filter(point => {
                    const key = `${point.timestamp}-${point.price}`;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });
            }

            // Get storage statistics
            getStorageStats() {
                const stats = {
                    totalSize: 0,
                    layerSizes: {},
                    totalPoints: 0,
                    layerPoints: {},
                    compressionRatio: 0
                };

                Object.entries(this.layers).forEach(([layerName, layerKey]) => {
                    const data = localStorage.getItem(layerKey) || '{}';
                    const sizeKB = (data.length / 1024).toFixed(1);
                    stats.layerSizes[layerName] = sizeKB;
                    stats.totalSize += parseFloat(sizeKB);

                    const parsedData = JSON.parse(data);
                    const points = Object.values(parsedData).reduce((sum, symbolData) => 
                        sum + (symbolData ? symbolData.length : 0), 0);
                    stats.layerPoints[layerName] = points;
                    stats.totalPoints += points;
                });

                return stats;
            }

            // Enhanced compression with better algorithms
            compressData() {
                this.logAction('Starting advanced data compression...', 'success');
                
                // Compress recent to daily
                this.compressLayer('recent', 'daily', this.compressToHourly);
                
                // Compress daily to weekly  
                this.compressLayer('daily', 'weekly', this.compressToDaily);
                
                // Compress weekly to monthly
                this.compressLayer('weekly', 'monthly', this.compressToWeekly);
                
                this.logAction('Data compression completed', 'success');
                this.updateUI();
            }

            compressLayer(fromLayer, toLayer, compressionFunc) {
                const fromData = JSON.parse(localStorage.getItem(this.layers[fromLayer]) || '{}');
                const toData = JSON.parse(localStorage.getItem(this.layers[toLayer]) || '{}');
                
                Object.keys(fromData).forEach(symbol => {
                    if (!toData[symbol]) toData[symbol] = [];
                    
                    const compressed = compressionFunc.call(this, fromData[symbol]);
                    toData[symbol] = [...toData[symbol], ...compressed];
                    
                    // Remove compressed data from source layer
                    fromData[symbol] = fromData[symbol].slice(-100); // Keep recent data
                });
                
                localStorage.setItem(this.layers[fromLayer], JSON.stringify(fromData));
                localStorage.setItem(this.layers[toLayer], JSON.stringify(toData));
            }

            compressToHourly(points) {
                return this.compressToTimeframe(points, 60 * 60 * 1000); // 1 hour
            }

            compressToDaily(points) {
                return this.compressToTimeframe(points, 24 * 60 * 60 * 1000); // 1 day
            }

            compressToWeekly(points) {
                return this.compressToTimeframe(points, 7 * 24 * 60 * 60 * 1000); // 1 week
            }

            compressToTimeframe(points, timeframe) {
                const groups = {};
                
                points.forEach(point => {
                    const groupKey = Math.floor(point.timestamp / timeframe);
                    if (!groups[groupKey]) {
                        groups[groupKey] = [];
                    }
                    groups[groupKey].push(point.price);
                });
                
                return Object.keys(groups).map(groupKey => {
                    const prices = groups[groupKey];
                    const avgPrice = prices.reduce((sum, price) => sum + price, 0) / prices.length;
                    const timestamp = parseInt(groupKey) * timeframe;
                    
                    return { timestamp, price: avgPrice };
                });
            }

            logAction(message, type = 'info') {
                const logContainer = document.getElementById('systemLog');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            // Export enhanced data
            exportData() {
                const exportData = {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    storageStats: this.getStorageStats(),
                    layers: {}
                };

                Object.entries(this.layers).forEach(([layerName, layerKey]) => {
                    exportData.layers[layerName] = JSON.parse(localStorage.getItem(layerKey) || '{}');
                });

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `enhanced-price-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.logAction('Data exported successfully', 'success');
            }
        }

        // Initialize the enhanced storage system
        const enhancedStorage = new EnhancedDataStorage();

        // Update UI with current stats
        function updateUI() {
            const stats = enhancedStorage.getStorageStats();
            
            // Update storage stats
            document.getElementById('storageStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-title">Total Data Points</div>
                    <div class="stat-value">${stats.totalPoints.toLocaleString()}</div>
                    <div class="stat-subtitle">Across all layers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Storage Used</div>
                    <div class="stat-value">${stats.totalSize.toFixed(1)} KB</div>
                    <div class="stat-subtitle">Multi-layer compression</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Compression Ratio</div>
                    <div class="stat-value">${(stats.totalPoints / stats.totalSize * 10).toFixed(1)}:1</div>
                    <div class="stat-subtitle">vs standard storage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Data Layers</div>
                    <div class="stat-value">${Object.keys(stats.layerSizes).length}</div>
                    <div class="stat-subtitle">Active storage layers</div>
                </div>
            `;

            // Update layer information
            document.getElementById('dataLayers').innerHTML = Object.entries(stats.layerSizes).map(([layer, size]) => `
                <div class="layer-card">
                    <div class="layer-title">
                        ${getLayerIcon(layer)} ${layer.charAt(0).toUpperCase() + layer.slice(1)} Layer
                    </div>
                    <div class="layer-description">
                        ${getLayerDescription(layer)}
                    </div>
                    <div class="layer-stats">
                        <div class="layer-stat">
                            <strong>${stats.layerPoints[layer]}</strong><br>
                            Data Points
                        </div>
                        <div class="layer-stat">
                            <strong>${size} KB</strong><br>
                            Storage Used
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getLayerIcon(layer) {
            const icons = {
                recent: '‚ö°',
                daily: 'üìÖ',
                weekly: 'üìä',
                monthly: 'üìà',
                compressed: 'üóúÔ∏è'
            };
            return icons[layer] || 'üì¶';
        }

        function getLayerDescription(layer) {
            const descriptions = {
                recent: 'Full resolution data for the last 24 hours. Updated every minute for real-time tracking.',
                daily: 'Hourly averages for the past 30 days. Optimized for daily trend analysis.',
                weekly: 'Daily averages for the past year. Perfect for weekly and monthly charts.',
                monthly: 'Weekly averages for long-term historical analysis. Covers multiple years.',
                compressed: 'Ultra-compressed historical data using advanced algorithms.'
            };
            return descriptions[layer] || 'Data storage layer';
        }

        // Demo functions for the interface
        function startHistoricalDataCollection() {
            enhancedStorage.logAction('Historical data collection started...', 'success');
            
            // Simulate adding historical data
            const symbols = ['BTC', 'ETH', 'GOLD', 'SPY'];
            let progress = 0;
            const totalSteps = 100;
            
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressBar.innerHTML = '<div class="progress-fill"></div>';
            document.querySelector('.controls').after(progressBar);
            
            const interval = setInterval(() => {
                // Simulate collecting historical data
                symbols.forEach(symbol => {
                    const basePrice = Math.random() * 1000 + 100;
                    const timestamp = Date.now() - (Math.random() * 365 * 24 * 60 * 60 * 1000);
                    enhancedStorage.addDataPoint(symbol, basePrice, timestamp);
                });
                
                progress += 1;
                const progressPercent = (progress / totalSteps) * 100;
                progressBar.querySelector('.progress-fill').style.width = `${progressPercent}%`;
                
                if (progress >= totalSteps) {
                    clearInterval(interval);
                    enhancedStorage.logAction(`Collected ${totalSteps * symbols.length} historical data points`, 'success');
                    progressBar.remove();
                    updateUI();
                }
            }, 50);
        }

        function compressData() {
            enhancedStorage.compressData();
        }

        function exportEnhancedData() {
            enhancedStorage.exportData();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            enhancedStorage.logAction(`Importing data version ${data.version}...`, 'success');
                            // Import logic would go here
                            enhancedStorage.logAction('Data imported successfully', 'success');
                        } catch (error) {
                            enhancedStorage.logAction('Error importing data: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function analyzeStorage() {
            const stats = enhancedStorage.getStorageStats();
            enhancedStorage.logAction('=== STORAGE ANALYSIS ===', 'success');
            enhancedStorage.logAction(`Total storage: ${stats.totalSize.toFixed(1)} KB`, 'info');
            enhancedStorage.logAction(`Total data points: ${stats.totalPoints}`, 'info');
            enhancedStorage.logAction(`Average bytes per point: ${(stats.totalSize * 1024 / stats.totalPoints).toFixed(1)}`, 'info');
            
            Object.entries(stats.layerSizes).forEach(([layer, size]) => {
                enhancedStorage.logAction(`${layer}: ${size} KB (${stats.layerPoints[layer]} points)`, 'info');
            });
        }

        // Initialize UI
        updateUI();
        
        // Add some demo data
        setTimeout(() => {
            const demoSymbols = ['BTC', 'ETH', 'GOLD', 'SPY'];
            demoSymbols.forEach(symbol => {
                for (let i = 0; i < 100; i++) {
                    const price = Math.random() * 1000 + 100;
                    const timestamp = Date.now() - (i * 60000); // Every minute going back
                    enhancedStorage.addDataPoint(symbol, price, timestamp);
                }
            });
            updateUI();
            enhancedStorage.logAction('Demo data loaded', 'success');
        }, 1000);
    </script>
</body>
</html>