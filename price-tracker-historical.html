<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Track prices of everything with historical charts - Bitcoin, Gold, Rolex watches, Pokemon cards, and more!">
    <meta name="keywords" content="price tracker, bitcoin, cryptocurrency, gold, rolex, stocks, commodities, historical charts">
    <title>Universal Price Tracker - Long-Term Market Analysis</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>📈</text></svg>">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .chart-tooltip-change.positive {
            color: #00ff88;
        }

        .chart-tooltip-change.negative {
            color: #ff4d4d;
        }

        .background-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #00ff88;
            margin-left: 15px;
            animation: pulse 2s ease-in-out infinite;
        }

        .background-indicator.inactive {
            background: rgba(255, 77, 77, 0.1);
            border-color: rgba(255, 77, 77, 0.3);
            color: #ff4d4d;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeInDown 0.8s ease-out;
        }

        h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 700;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #888;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: clamp(20px, 3vw, 40px);
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .stat-box {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 120px;
        }

        .stat-box h3 {
            font-size: 2rem;
            color: #00d4ff;
            margin-bottom: 5px;
        }

        .stat-box p {
            color: #888;
            font-size: 0.9rem;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .search-bar {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input::placeholder {
            color: #666;
        }

        .search-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: #00d4ff;
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            pointer-events: none;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .btn.active {
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            color: #0f0f1e;
            border-color: transparent;
        }

        .update-info {
            text-align: center;
            margin: 20px 0;
        }

        .update-time {
            font-size: 0.9rem;
            color: #666;
        }

        .data-info {
            font-size: 0.85rem;
            color: #00ff88;
            margin-top: 5px;
        }

        .category-section {
            margin-bottom: 40px;
        }

        .category-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: #00d4ff;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            border-radius: 2px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .items-list {
            display: none;
        }

        .items-list .item-card {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(15px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .item-card.trending {
            border-color: rgba(255, 107, 53, 0.4);
            box-shadow: 0 8px 32px rgba(255, 107, 53, 0.15);
        }

        .trending-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #ff6b35, #ff8e35);
            color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
            z-index: 5;
            animation: hotPulse 2s ease-in-out infinite;
        }

        @keyframes hotPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 4px 16px rgba(255, 107, 53, 0.5);
            }
        }

        .item-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 16px 40px rgba(0, 212, 255, 0.25);
            border-color: rgba(0, 212, 255, 0.4);
            background: rgba(255, 255, 255, 0.12);
        }

        .item-card:active {
            transform: translateY(-4px) scale(1.01);
        }

        .favorite-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: #666;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .favorite-btn:hover {
            color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.4);
            transform: scale(1.1);
        }

        .favorite-btn.active {
            color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.4);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            margin-top: 10px;
        }

        .item-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            margin-right: 15px;
        }

        .item-icon {
            font-size: 1.8rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .item-symbol {
            font-size: 0.85rem;
            color: #888;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 500;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .price-container {
            margin-bottom: 20px;
            padding: 15px 0;
        }

        .current-price {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .price-change {
            display: inline-flex;
            align-items: center;
            font-size: 0.95rem;
            padding: 8px 14px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            gap: 6px;
            border: 1px solid;
        }

        .price-change.positive {
            background: rgba(0, 255, 136, 0.15);
            color: #00ff88;
            border-color: rgba(0, 255, 136, 0.3);
        }

        .price-change.negative {
            background: rgba(255, 77, 77, 0.15);
            color: #ff4d4d;
            border-color: rgba(255, 77, 77, 0.3);
        }

        .item-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }

        .stat {
            font-size: 0.9rem;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            color: #888;
            margin-bottom: 6px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-weight: 600;
            color: #fff;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .chart-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }

        .chart-period {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.8rem;
        }

        .chart-mini {
            height: 80px;
            background: rgba(0, 212, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0, 212, 255, 0.1);
        }

        .chart-small {
            height: 80px !important;
            width: 100% !important;
        }

        .chart-loading {
            color: #666;
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .chart-loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-top: 2px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-content {
            position: relative;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 50px auto;
            padding: 40px;
            max-width: 900px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            animation: slideIn 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .chart-large {
            height: 450px;
            background: rgba(0, 212, 255, 0.05);
            border-radius: 16px;
            margin: 30px 0;
            padding: 25px;
            position: relative;
            border: 1px solid rgba(0, 212, 255, 0.1);
        }

        .period-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .period-selector .btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            min-width: 50px;
        }

        .modal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .modal-stats .stat-box {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 16px;
        }

        .modal-stats .stat-box h3.positive {
            color: #00ff88;
        }

        .modal-stats .stat-box h3.negative {
            color: #ff4d4d;
        }

        .no-chart-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            gap: 10px;
        }

        .no-chart-data-icon {
            font-size: 2.5rem;
            opacity: 0.5;
        }

        .clickable-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            cursor: pointer;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            border: none;
            color: #0f0f1e;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
            font-size: 1rem;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .refresh-btn:active {
            transform: scale(0.98);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            color: #666;
            cursor: pointer;
            background: none;
            border: none;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #fff;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .modal-price {
            font-size: 3rem;
            font-weight: 700;
            margin: 20px 0;
        }

        .modal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .chart-large {
            height: 400px;
            background: rgba(0, 212, 255, 0.05);
            border-radius: 10px;
            margin: 30px 0;
            padding: 20px;
            position: relative;
        }

        .chart-small {
            height: 60px;
            width: 100%;
            margin-top: 15px;
            position: relative;
        }

        .chart-container {
            position: relative;
            height: 100%;
            width: 100%;
        }

        .chart-container canvas {
            display: block !important;
            max-width: 100%;
            height: auto;
        }

        .period-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .data-controls {
            text-align: center;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-btn {
            background: rgba(255, 77, 77, 0.2);
            color: #ff4d4d;
            border: 1px solid #ff4d4d;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .data-btn:hover {
            background: rgba(255, 77, 77, 0.3);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .stats-bar {
                gap: 10px;
            }
            
            .stat-box {
                padding: 15px;
                min-width: 100px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-bar {
                max-width: none;
            }
            
            .view-toggle {
                justify-content: center;
            }
            
            .items-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 20px auto;
                padding: 20px;
                max-width: 95vw;
            }
            
            .item-card {
                padding: 20px;
            }
            
            .trending-badge {
                top: 12px;
                right: 12px;
                padding: 4px 8px;
                font-size: 0.7rem;
            }
            
            .favorite-btn {
                top: 12px;
                left: 12px;
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }
            
            .item-name {
                font-size: 1.1rem;
            }
            
            .current-price {
                font-size: 1.8rem;
            }
            
            .chart-mini {
                height: 70px;
            }
            
            .chart-small {
                height: 70px !important;
            }
        }

        .footer {
            text-align: center;
            margin-top: 60px;
            padding: 20px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .footer a {
            color: #00d4ff;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Universal Price Tracker</h1>
            <p class="subtitle">Long-term market trends across all asset classes</p>
            
            <div class="stats-bar" id="statsBar">
                <div class="stat-box">
                    <h3 id="totalItems">0</h3>
                    <p>Items Tracked</p>
                </div>
                <div class="stat-box">
                    <h3 id="gainers">0</h3>
                    <p>Week Gainers</p>
                </div>
                <div class="stat-box">
                    <h3 id="losers">0</h3>
                    <p>Week Losers</p>
                </div>
                <div class="stat-box">
                    <h3 id="dataPoints">0</h3>
                    <p>Data Points</p>
                </div>
            </div>

            <div class="controls">
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Search items..." id="searchInput">
                    <span class="search-icon">🔍</span>
                </div>
                
                <div class="view-toggle">
                    <button class="btn active" onclick="setView('grid')">Grid</button>
                    <button class="btn" onclick="setView('list')">List</button>
                    <button class="btn" onclick="showFavorites()">⭐ Favorites</button>
                </div>
            </div>

            <div class="update-info">
                <p class="update-time">
                    Last updated: <span id="updateTime">--:--:--</span>
                    <span class="background-indicator" id="bgIndicator">
                        <span style="width: 6px; height: 6px; background: currentColor; border-radius: 50%; display: inline-block;"></span>
                        Background Collection Active
                    </span>
                    <span class="background-indicator" id="dataSourceIndicator" style="background: rgba(0, 255, 136, 0.1); border-color: rgba(0, 255, 136, 0.3); color: #00ff88;">
                        <span style="width: 6px; height: 6px; background: currentColor; border-radius: 50%; display: inline-block;"></span>
                        Real Market Data
                    </span>
                </p>
                <p class="data-info" id="dataInfo">Building long-term charts with real market data...</p>
                <p style="color: #666; font-size: 0.8rem; margin-top: 5px;">Updates every 5 minutes • Real data from multiple verified sources</p>
            </div>
        </header>

        <div id="categoriesContainer">
            <div style="text-align: center; padding: 60px 20px; color: #666;">
                <div style="font-size: 3rem; margin-bottom: 20px;">📊</div>
                <div style="font-size: 1.2rem; margin-bottom: 10px;">Loading Price Tracker...</div>
                <div class="chart-loading-spinner" style="margin: 20px auto;"></div>
                <div style="font-size: 0.9rem;">Initializing data and charts...</div>
            </div>
        </div>

        <button class="refresh-btn" onclick="manualRefresh()">🔄 Update Prices</button>

        <div class="data-controls">
            <p style="color: #666; margin-bottom: 10px;">Data Management (1 Year Retention)</p>
            <button class="data-btn" onclick="exportData()">📥 Export Data</button>
            <button class="data-btn" onclick="clearOldData()">🗑️ Clean Old Data</button>
            <button class="data-btn" onclick="clearAllData()">⚠️ Clear All Data</button>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal" onclick="closeModalOnBg(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <footer class="footer">
        <p>💡 Historical data stored locally • Updates every 5 minutes • Data retained for 1 year</p>
        <p>Charts show weekly/monthly trends • Perfect for long-term market analysis</p>
    </footer>

    <script>
        // Complete data structure with all categories
        const categories = {
            'Precious Metals': [
                { name: 'Gold', symbol: 'XAU', unit: '/oz', basePrice: 2050, icon: '🥇', volatility: 0.002 },
                { name: 'Silver', symbol: 'XAG', unit: '/oz', basePrice: 24.50, icon: '🥈', volatility: 0.003 },
                { name: 'Platinum', symbol: 'XPT', unit: '/oz', basePrice: 980, icon: '💎', volatility: 0.003 },
                { name: 'Palladium', symbol: 'XPD', unit: '/oz', basePrice: 1450, icon: '⚪', volatility: 0.004 }
            ],
            'Cryptocurrencies': [
                { name: 'Bitcoin', symbol: 'BTC', unit: '', basePrice: 45000, icon: '₿', volatility: 0.02 },
                { name: 'Ethereum', symbol: 'ETH', unit: '', basePrice: 2500, icon: 'Ξ', volatility: 0.025 },
                { name: 'Solana', symbol: 'SOL', unit: '', basePrice: 120, icon: '◎', volatility: 0.03 },
                { name: 'Dogecoin', symbol: 'DOGE', unit: '', basePrice: 0.08, icon: '🐕', volatility: 0.04 }
            ],
            'Stock Indices': [
                { name: 'S&P 500', symbol: 'SPY', unit: '', basePrice: 450, icon: '📈', volatility: 0.01 },
                { name: 'Nasdaq', symbol: 'QQQ', unit: '', basePrice: 380, icon: '💹', volatility: 0.012 },
                { name: 'Dow Jones', symbol: 'DIA', unit: '', basePrice: 350, icon: '📊', volatility: 0.008 }
            ],
            'Luxury Watches': [
                { name: 'Rolex Submariner', symbol: 'ROLEX-SUB', unit: '', basePrice: 9500, icon: '⌚', volatility: 0.001 },
                { name: 'Rolex Daytona', symbol: 'ROLEX-DAY', unit: '', basePrice: 35000, icon: '⌚', volatility: 0.001 },
                { name: 'AP Royal Oak', symbol: 'AP-RO', unit: '', basePrice: 35000, icon: '⌚', volatility: 0.002 },
                { name: 'Patek Nautilus', symbol: 'PATEK-NAU', unit: '', basePrice: 70000, icon: '⌚', volatility: 0.002 }
            ],
            'Collectibles': [
                { name: 'Charizard PSA 10', symbol: 'CHAR-PSA10', unit: '', basePrice: 350000, icon: '🔥', volatility: 0.005 },
                { name: 'Black Lotus', symbol: 'MTG-LOTUS', unit: '', basePrice: 500000, icon: '🌸', volatility: 0.004 },
                { name: 'Action Comics #1', symbol: 'AC1', unit: '', basePrice: 3200000, icon: '📚', volatility: 0.003 }
            ],
            'Consumer Goods': [
                { name: 'Eggs (dozen)', symbol: 'EGGS', unit: '', basePrice: 4.25, icon: '🥚', volatility: 0.01 },
                { name: 'Milk (gallon)', symbol: 'MILK', unit: '', basePrice: 4.50, icon: '🥛', volatility: 0.008 },
                { name: 'Gas (gallon)', symbol: 'GAS', unit: '', basePrice: 3.45, icon: '⛽', volatility: 0.02 },
                { name: 'Coffee (lb)', symbol: 'COFFEE', unit: '', basePrice: 12.99, icon: '☕', volatility: 0.015 }
            ],
            'Real Estate': [
                { name: 'US Median House', symbol: 'HOUSE-US', unit: '', basePrice: 420000, icon: '🏠', volatility: 0.0005 },
                { name: 'Canada Median House', symbol: 'HOUSE-CA', unit: '', basePrice: 750000, icon: '🏡', volatility: 0.0007 },
                { name: 'NYC Apt/sqft', symbol: 'NYC-SQFT', unit: '/sqft', basePrice: 1500, icon: '🏢', volatility: 0.001 }
            ],
            'Technology': [
                { name: 'RTX 4090', symbol: 'RTX-4090', unit: '', basePrice: 1599, icon: '🎮', volatility: 0.01 },
                { name: 'iPhone 15 Pro', symbol: 'IPHONE15', unit: '', basePrice: 999, icon: '📱', volatility: 0.005 },
                { name: 'PS5', symbol: 'PS5', unit: '', basePrice: 499, icon: '🎮', volatility: 0.008 }
            ]
        };

        // Constants
        const UPDATE_INTERVAL = 300000; // 5 minutes (more appropriate for long-term tracking)
        const MAX_DATA_AGE = 365 * 24 * 60 * 60 * 1000; // 1 year of data
        const STORAGE_KEY = 'priceTrackerHistory';
        const SETTINGS_KEY = 'priceTrackerSettings';
        const DEFAULT_PERIOD = '1W'; // Default to weekly view

        // State management
        let currentPrices = {};
        let historicalData = {};
        let favorites = [];
        let currentView = 'grid';
        let searchQuery = '';
        let updateInterval;
        let selectedPeriod = '1M'; // Default to monthly view

        // Initialize or load historical data
        function initializeData() {
            // Load saved data
            const savedData = localStorage.getItem(STORAGE_KEY);
            const savedSettings = localStorage.getItem(SETTINGS_KEY);
            
            if (savedData) {
                try {
                    historicalData = JSON.parse(savedData);
                    cleanOldData(); // Clean data older than 30 days
                } catch (e) {
                    console.error('Error loading saved data:', e);
                    historicalData = {};
                }
            }

            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    favorites = settings.favorites || [];
                } catch (e) {
                    favorites = [];
                }
            }

            // Initialize current prices
            Object.values(categories).flat().forEach(item => {
                if (!historicalData[item.symbol]) {
                    historicalData[item.symbol] = [];
                }
                
                // Get last known price or use base price
                const history = historicalData[item.symbol];
                const lastEntry = history[history.length - 1];
                const basePrice = lastEntry ? lastEntry.price : item.basePrice * (0.95 + Math.random() * 0.1);
                
                currentPrices[item.symbol] = basePrice;
                
                // Add initial data point if none exists
                if (history.length === 0) {
                    addDataPoint(item.symbol, basePrice);
                    // Started tracking item
                }
            });

            // Show welcome message for new users
            if (Object.values(historicalData).every(h => h.length <= 1)) {
                setTimeout(() => {
                    alert('Welcome to Universal Price Tracker!\n\n' +
                          '📊 This tracker focuses on long-term market trends.\n' +
                          '⏰ Prices update every 5 minutes.\n' +
                          '📈 Charts will build up over days/weeks.\n' +
                          '💾 All data is saved locally in your browser.\n\n' +
                          'Leave this page open or bookmark it to build your historical data!');
                }, 1000);
            }

            saveData();
        }

        // Add a data point
        function addDataPoint(symbol, price) {
            if (!historicalData[symbol]) {
                historicalData[symbol] = [];
            }
            
            historicalData[symbol].push({
                timestamp: Date.now(),
                price: price
            });

            // Keep reasonable data size - more for longer term tracking
            if (historicalData[symbol].length > 50000) {
                historicalData[symbol] = historicalData[symbol].slice(-25000);
            }
        }

        // Get historical data for a period
        function getHistoricalData(symbol, period = '1W') {
            const data = historicalData[symbol] || [];
            if (data.length === 0) return [];

            const now = Date.now();
            let startTime;

            switch (period) {
                case '24h':
                    startTime = now - (24 * 60 * 60 * 1000);
                    break;
                case '1W':
                    startTime = now - (7 * 24 * 60 * 60 * 1000);
                    break;
                case '1M':
                    startTime = now - (30 * 24 * 60 * 60 * 1000);
                    break;
                case '3M':
                    startTime = now - (90 * 24 * 60 * 60 * 1000);
                    break;
                case '1Y':
                    startTime = now - (365 * 24 * 60 * 60 * 1000);
                    break;
                case 'ALL':
                    startTime = 0;
                    break;
                default:
                    startTime = now - (7 * 24 * 60 * 60 * 1000); // Default to 1 week
            }

            return data.filter(point => point.timestamp >= startTime);
        }

        // Calculate statistics
        function calculateStats(data) {
            if (!data || data.length === 0) {
                return { change: 0, changePercent: 0, high: 0, low: 0, open: 0 };
            }

            const prices = data.map(d => d.price);
            const open = prices[0];
            const close = prices[prices.length - 1];
            const high = Math.max(...prices);
            const low = Math.min(...prices);
            const change = close - open;
            const changePercent = open > 0 ? (change / open) * 100 : 0;

            return { change, changePercent, high, low, open, close };
        }

        // Format price
        function formatPrice(price) {
            if (!price || isNaN(price)) return '$0';
            if (price >= 1000000) {
                return `${(price / 1000000).toFixed(2)}M`;
            } else if (price >= 10000) {
                return `${(price / 1000).toFixed(1)}K`;
            } else if (price >= 100) {
                return `${price.toFixed(0)}`;
            } else if (price >= 10) {
                return `${price.toFixed(2)}`;
            } else {
                return `${price.toFixed(4)}`;
            }
        }

        // Check if trending (significant weekly movement)
        function isTrending(symbol) {
            const data = getHistoricalData(symbol, '1W');
            const stats = calculateStats(data);
            return Math.abs(stats.changePercent) > 5; // 5% weekly change is significant
        }

        // Legacy SVG chart function - now using Chart.js for all charts
        function createChart(data, width = 280, height = 60, showDots = false, symbol = '') {
            // This function is deprecated - all charts now use Chart.js
            return `<div class="chart-loading">
                <div class="chart-loading-spinner"></div>
                <span>Loading chart...</span>
            </div>`;
        }

        // Toggle favorite
        function toggleFavorite(symbol, event) {
            event.stopPropagation();
            const index = favorites.indexOf(symbol);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(symbol);
            }
            saveSettings();
            render();
        }

        // Create item card
        function createCard(item) {
            const price = currentPrices[item.symbol];
            const dataWeek = getHistoricalData(item.symbol, '1W');
            const dataMonth = getHistoricalData(item.symbol, '1M');
            const stats = calculateStats(dataWeek);
            const isFavorite = favorites.includes(item.symbol);
            const trending = isTrending(item.symbol);

            if (currentView === 'list') {
                return `
                    <div class="item-card" onclick="showDetails('${item.symbol}')">
                        <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                            <button class="favorite-btn ${isFavorite ? 'active' : ''}" 
                                    onclick="toggleFavorite('${item.symbol}', event)">
                                ${isFavorite ? '⭐' : '☆'}
                            </button>
                            <span class="item-icon">${item.icon}</span>
                            <div>
                                <div style="font-weight: 600;">${item.name}</div>
                                <span class="item-symbol">${item.symbol}</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="current-price" style="font-size: 1.5rem;">
                                ${formatPrice(price)}${item.unit}
                            </div>
                            <span class="price-change ${stats.changePercent >= 0 ? 'positive' : 'negative'}">
                                ${stats.changePercent >= 0 ? '▲' : '▼'} ${Math.abs(stats.changePercent).toFixed(2)}%
                            </span>
                        </div>
                    </div>
                `;
            }

            // Use monthly data for the chart, weekly for stats
            const chartData = dataMonth.length > 10 ? dataMonth : dataWeek;

            return `
                <div class="item-card ${trending ? 'trending' : ''}" data-symbol="${item.symbol}">
                    <div class="clickable-overlay" onclick="showDetails('${item.symbol}')"></div>
                    
                    <button class="favorite-btn ${isFavorite ? 'active' : ''}" 
                            onclick="toggleFavorite('${item.symbol}', event)">
                        ${isFavorite ? '⭐' : '☆'}
                    </button>
                    ${trending ? '<span class="trending-badge">🔥 Hot</span>' : ''}
                    
                    <div class="item-header">
                        <div class="item-name">
                            <span class="item-icon">${item.icon}</span>
                            <span>${item.name}</span>
                        </div>
                        <span class="item-symbol">${item.symbol}</span>
                    </div>
                    
                    <div class="price-container">
                        <div class="current-price" id="price-${item.symbol}">
                            ${formatPrice(price)}${item.unit}
                        </div>
                        <span class="price-change ${stats.changePercent >= 0 ? 'positive' : 'negative'}" 
                              id="change-${item.symbol}"
                              title="Weekly change">
                            ${stats.changePercent >= 0 ? '▲' : '▼'} ${Math.abs(stats.changePercent).toFixed(2)}%
                        </span>
                    </div>
                    
                    <div class="item-stats">
                        <div class="stat">
                            <div class="stat-label">Week High</div>
                            <div class="stat-value" id="high-${item.symbol}">
                                ${formatPrice(stats.high || price)}
                            </div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Week Low</div>
                            <div class="stat-value" id="low-${item.symbol}">
                                ${formatPrice(stats.low || price)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-period">
                            <span style="color: #888; font-weight: 500;">${chartData.length > 100 ? '1M' : '1W'} Trend</span>
                            <span style="color: #666; font-size: 0.75rem;">
                                ${chartData.length < 10 ? '🔄 Building...' : chartData.length + ' points'}
                            </span>
                        </div>
                        <div class="chart-mini" id="chart-${item.symbol}">
                            <canvas id="miniChart-${item.symbol}" class="chart-small"></canvas>
                        </div>
                    </div>
                </div>
            `;
        }

        // Chart functionality
        let modalChart = null;
        const miniCharts = {};

        // Create mini chart for grid items
        function createMiniChart(symbol) {
            const canvas = document.getElementById(`miniChart-${symbol}`);
            if (!canvas) {
                console.warn(`Canvas not found for ${symbol}`);
                return;
            }

            const ctx = canvas.getContext('2d');
            const data = getHistoricalData(symbol, '1W'); // Use weekly data for better visualization
            
            if (miniCharts[symbol]) {
                miniCharts[symbol].destroy();
            }

            // Show loading state if not enough data
            const chartContainer = canvas.parentElement;
            if (data.length < 2) {
                chartContainer.innerHTML = `
                    <div class="chart-loading">
                        <div class="chart-loading-spinner"></div>
                        <span>Building chart...</span>
                    </div>
                `;
                return;
            }

            // Ensure canvas is visible and properly sized
            canvas.style.display = 'block';
            canvas.width = chartContainer.offsetWidth || 280;
            canvas.height = 80;

            const chartData = data.map(point => ({
                x: new Date(point.timestamp),
                y: point.price
            }));

            const firstPrice = data[0].price;
            const lastPrice = data[data.length - 1].price;
            const isPositive = lastPrice >= firstPrice;

            try {
                miniCharts[symbol] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            data: chartData,
                            borderColor: isPositive ? '#00ff88' : '#ff4d4d',
                            borderWidth: 2,
                            fill: true,
                            backgroundColor: isPositive 
                                ? 'rgba(0, 255, 136, 0.15)' 
                                : 'rgba(255, 77, 77, 0.15)',
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 3,
                            pointBackgroundColor: isPositive ? '#00ff88' : '#ff4d4d'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { 
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: isPositive ? '#00ff88' : '#ff4d4d',
                                borderWidth: 1,
                                displayColors: false,
                                callbacks: {
                                    title: function(context) {
                                        return new Date(context[0].parsed.x).toLocaleDateString();
                                    },
                                    label: function(context) {
                                        return `${formatPrice(context.parsed.y)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        },
                        elements: {
                            point: { radius: 0 }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        onHover: (event, activeElements) => {
                            event.native.target.style.cursor = activeElements.length > 0 ? 'crosshair' : 'pointer';
                        }
                    }
                });
            } catch (error) {
                console.error(`Error creating chart for ${symbol}:`, error);
                chartContainer.innerHTML = `
                    <div class="no-chart-data">
                        <div class="no-chart-data-icon">📊</div>
                        <span>Chart error</span>
                    </div>
                `;
            }
        }

        // Create modal chart with Chart.js
        function createModalChart(symbol, period = '1M') {
            const canvas = document.getElementById('modalChartCanvas');
            if (!canvas) {
                console.error('Modal chart canvas not found');
                return;
            }

            const ctx = canvas.getContext('2d');
            const data = getHistoricalData(symbol, period);

            if (modalChart) {
                modalChart.destroy();
                modalChart = null;
            }

            if (data.length < 2) {
                const chartContainer = document.getElementById('modalChart');
                chartContainer.innerHTML = `
                    <div class="no-chart-data" style="height: 400px;">
                        <div class="no-chart-data-icon">📊</div>
                        <div style="font-size: 1.1rem; margin-bottom: 10px;">Not enough historical data for ${period}</div>
                        <div style="font-size: 0.9rem; color: #888;">Data collection in progress...</div>
                        <div style="margin-top: 15px; font-size: 0.8rem; color: #666;">
                            Current data points: ${data.length} • Need at least 2 points
                        </div>
                    </div>
                `;
                return;
            }

            // Ensure canvas is properly sized
            canvas.width = canvas.offsetWidth || 800;
            canvas.height = 400;

            const chartData = data.map(point => ({
                x: new Date(point.timestamp),
                y: point.price
            }));

            const firstPrice = data[0].price;
            const lastPrice = data[data.length - 1].price;
            const isPositive = lastPrice >= firstPrice;

            // Find min and max for better scaling
            const prices = data.map(d => d.price);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const padding = (maxPrice - minPrice) * 0.1;

            modalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: `Price History (${period})`,
                        data: chartData,
                        borderColor: isPositive ? '#00ff88' : '#ff4d4d',
                        borderWidth: 2,
                        fill: true,
                        backgroundColor: isPositive 
                            ? 'rgba(0, 255, 136, 0.1)' 
                            : 'rgba(255, 77, 77, 0.1)',
                        tension: 0.4,
                        pointRadius: 1,
                        pointHoverRadius: 6,
                        pointBackgroundColor: isPositive ? '#00ff88' : '#ff4d4d',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: isPositive ? '#00ff88' : '#ff4d4d',
                            borderWidth: 1,
                            displayColors: false,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 },
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleString();
                                },
                                label: function(context) {
                                    const price = context.parsed.y;
                                    const item = Object.values(categories).flat().find(i => i.symbol === symbol);
                                    return `Price: ${formatPrice(price)}${item?.unit || ''}`;
                                },
                                afterLabel: function(context) {
                                    const currentIndex = context.dataIndex;
                                    if (currentIndex > 0) {
                                        const previousPrice = chartData[currentIndex - 1].y;
                                        const currentPrice = context.parsed.y;
                                        const change = currentPrice - previousPrice;
                                        const changePercent = (change / previousPrice) * 100;
                                        const changeText = change >= 0 ? '+' : '';
                                        return `Change: ${changeText}${formatPrice(Math.abs(change))} (${changeText}${changePercent.toFixed(2)}%)`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    hour: 'HH:mm',
                                    day: 'MMM dd',
                                    week: 'MMM dd',
                                    month: 'MMM yyyy'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#888',
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            min: Math.max(0, minPrice - padding),
                            max: maxPrice + padding,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#888',
                                callback: function(value) {
                                    return formatPrice(value);
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'crosshair' : 'default';
                    }
                }
            });
        }

        // Show details modal
        function showDetails(symbol) {
            const item = Object.values(categories).flat().find(i => i.symbol === symbol);
            if (!item) return;

            const price = currentPrices[symbol];
            selectedPeriod = '1M'; // Default to monthly view

            function updateModalChart(period) {
                const data = getHistoricalData(symbol, period);
                const stats = calculateStats(data);
                
                createModalChart(symbol, period);
                document.getElementById('modalStats').innerHTML = `
                    <div class="stat-box">
                        <h3>${formatPrice(stats.open || price)}</h3>
                        <p>Open</p>
                    </div>
                    <div class="stat-box">
                        <h3>${formatPrice(stats.high || price)}</h3>
                        <p>High</p>
                    </div>
                    <div class="stat-box">
                        <h3>${formatPrice(stats.low || price)}</h3>
                        <p>Low</p>
                    </div>
                    <div class="stat-box">
                        <h3>${data.length}</h3>
                        <p>Data Points</p>
                    </div>
                    <div class="stat-box">
                        <h3 class="${stats.changePercent >= 0 ? 'positive' : 'negative'}">
                            ${stats.changePercent >= 0 ? '+' : ''}${stats.changePercent.toFixed(2)}%
                        </h3>
                        <p>Change</p>
                    </div>
                    <div class="stat-box">
                        <h3>${formatPrice(Math.abs(stats.change))}</h3>
                        <p>$ Change</p>
                    </div>
                `;

                // Update period buttons
                document.querySelectorAll('.period-selector .btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-period') === period) {
                        btn.classList.add('active');
                    }
                });
            }

            document.getElementById('modalContent').innerHTML = `
                <div class="modal-header">
                    <h2 style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                        <span style="font-size: 3rem;">${item.icon}</span>
                        <span>${item.name}</span>
                    </h2>
                    <p style="color: #888; margin-top: 10px;">${item.symbol}</p>
                </div>

                <div style="text-align: center;">
                    <div class="modal-price">${formatPrice(price)}${item.unit}</div>
                </div>

                <div class="period-selector">
                    <button class="btn" data-period="24h" onclick="updateModalChart('24h')">24H</button>
                    <button class="btn" data-period="1W" onclick="updateModalChart('1W')">1W</button>
                    <button class="btn active" data-period="1M" onclick="updateModalChart('1M')">1M</button>
                    <button class="btn" data-period="3M" onclick="updateModalChart('3M')">3M</button>
                    <button class="btn" data-period="1Y" onclick="updateModalChart('1Y')">1Y</button>
                    <button class="btn" data-period="ALL" onclick="updateModalChart('ALL')">ALL</button>
                </div>

                <div class="chart-large" id="modalChart">
                    <div class="chart-container">
                        <canvas id="modalChartCanvas" style="width: 100%; height: 100%;"></canvas>
                    </div>
                </div>

                <div class="modal-stats" id="modalStats"></div>

                <div style="text-align: center; margin-top: 20px; color: #666;">
                    <p>Base Price: ${formatPrice(item.basePrice)} • Volatility: ${(item.volatility * 100).toFixed(1)}%</p>
                    <p style="margin-top: 10px;">Total historical data points: ${historicalData[symbol].length}</p>
                </div>
            `;

            // Add chart update function to window for onclick
            window.updateModalChart = updateModalChart;
            updateModalChart('1M'); // Default to monthly view

            document.getElementById('detailModal').style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // Close modal on background click
        function closeModalOnBg(event) {
            if (event.target.id === 'detailModal') {
                closeModal();
            }
        }

        // Update single item price - REAL DATA VERSION
        async function updateItemPrice(item) {
            // Try to get real data from background agent first
            try {
                const response = await fetch('http://localhost:3001/api/prices', {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.prices && data.prices[item.symbol]) {
                        const realPrice = data.prices[item.symbol];
                        currentPrices[item.symbol] = realPrice;
                        addDataPoint(item.symbol, realPrice);
                        
                        // Update UI to show this is real data
                        const priceElement = document.getElementById(`price-${item.symbol}`);
                        if (priceElement && !priceElement.title) {
                            priceElement.title = '✅ Real market data';
                            priceElement.style.borderLeft = '3px solid #00ff88';
                        }
                        return; // Successfully got real data
                    }
                }
            } catch (error) {
                console.warn(`Failed to fetch real price for ${item.symbol}:`, error.message);
            }
            
            // Fallback to simulated data if real data unavailable
            const oldPrice = currentPrices[item.symbol];
            const adjustedVolatility = item.volatility / 3;
            const change = (Math.random() - 0.5) * adjustedVolatility;
            const newPrice = Math.max(oldPrice * (1 + change), item.basePrice * 0.1);
            
            currentPrices[item.symbol] = newPrice;
            addDataPoint(item.symbol, newPrice);
            
            // Update UI to show this is simulated data
            const priceElement = document.getElementById(`price-${item.symbol}`);
            if (priceElement) {
                priceElement.title = '⚠️ Simulated data (background agent offline)';
                priceElement.style.borderLeft = '3px solid #ff4d4d';
            }
        }

        // Update statistics
        function updateStats() {
            const allItems = Object.values(categories).flat();
            let gainers = 0;
            let losers = 0;
            let totalDataPoints = 0;

            allItems.forEach(item => {
                const data = getHistoricalData(item.symbol, '1W'); // Weekly stats
                const stats = calculateStats(data);
                if (stats.changePercent > 0) gainers++;
                else if (stats.changePercent < 0) losers++;
                
                totalDataPoints += (historicalData[item.symbol] || []).length;
            });

            document.getElementById('totalItems').textContent = allItems.length;
            document.getElementById('gainers').textContent = gainers;
            document.getElementById('losers').textContent = losers;
            document.getElementById('dataPoints').textContent = totalDataPoints.toLocaleString();

            // Update data info
            const oldestData = Math.min(...Object.values(historicalData).flat().map(d => d.timestamp).filter(t => t));
            const dataAge = oldestData ? Math.floor((Date.now() - oldestData) / (1000 * 60 * 60 * 24)) : 0;
            document.getElementById('dataInfo').textContent = 
                `Historical data: ${dataAge} days • Storage: ${(JSON.stringify(historicalData).length / 1024).toFixed(1)}KB`;
        }

        // Update all prices (removed duplicate - enhanced version exists below)

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(historicalData));
            } catch (e) {
                console.error('Error saving data:', e);
                // If storage is full, remove oldest data
                cleanOldData(true);
            }
        }

        // Save settings
        function saveSettings() {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify({ favorites }));
        }

        // Clean old data
        function cleanOldData(force = false) {
            const cutoffTime = Date.now() - MAX_DATA_AGE;
            let cleaned = false;

            Object.keys(historicalData).forEach(symbol => {
                const newData = historicalData[symbol].filter(point => point.timestamp > cutoffTime);
                if (newData.length < historicalData[symbol].length || force) {
                    historicalData[symbol] = force ? newData.slice(-1000) : newData;
                    cleaned = true;
                }
            });

            if (cleaned) {
                saveData();
            }
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify({
                version: '1.0',
                exportDate: new Date().toISOString(),
                data: historicalData,
                settings: { favorites }
            }, null, 2);
            
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `price-tracker-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all historical data? This cannot be undone.')) {
                historicalData = {};
                initializeData();
                render();
                alert('All data has been cleared.');
            }
        }

        // Clear old data manually
        function clearOldData() {
            const before = JSON.stringify(historicalData).length;
            cleanOldData(true);
            const after = JSON.stringify(historicalData).length;
            const saved = ((before - after) / 1024).toFixed(1);
            alert(`Old data cleaned up.\nFreed ${saved}KB of storage.\nKept most recent data points for each item.`);
            updateStats();
        }

        // Manual refresh
        function manualRefresh() {
            const btn = event.target;
            btn.style.transform = 'rotate(360deg)';
            btn.disabled = true;
            btn.textContent = '🔄 Updating...';
            
            updateAllPrices().then(() => {
                // Force refresh all charts after price update
                refreshAllCharts();
                render();
            });
            
            setTimeout(() => {
                btn.style.transform = 'rotate(0deg)';
                btn.disabled = false;
                btn.textContent = '🔄 Update Prices';
            }, 1000);
        }

        // Filter items
        function filterItems() {
            const query = searchQuery.toLowerCase();
            if (!query) return categories;

            const filtered = {};
            Object.entries(categories).forEach(([category, items]) => {
                const matches = items.filter(item => 
                    item.name.toLowerCase().includes(query) || 
                    item.symbol.toLowerCase().includes(query) ||
                    category.toLowerCase().includes(query)
                );
                if (matches.length > 0) {
                    filtered[category] = matches;
                }
            });
            return filtered;
        }

        // Render categories
        function renderCategories(categoriesToRender) {
            const container = document.getElementById('categoriesContainer');
            const cats = categoriesToRender || filterItems();
            
            if (Object.keys(cats).length === 0) {
                container.innerHTML = '<div class="no-results">No items found. Try a different search term.</div>';
                return;
            }

            container.innerHTML = Object.entries(cats).map(([name, items]) => `
                <div class="category-section">
                    <h2 class="category-title">${name}</h2>
                    <div class="items-${currentView}">
                        ${items.map(item => createCard(item)).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Show favorites
        function showFavorites() {
            if (favorites.length === 0) {
                document.getElementById('categoriesContainer').innerHTML = 
                    '<div class="no-results">No favorites yet! Click the star ⭐ on any item to add it.</div>';
                return;
            }

            const favoriteItems = Object.values(categories)
                .flat()
                .filter(item => favorites.includes(item.symbol));

            const favCategory = { 'Favorites ⭐': favoriteItems };
            renderCategories(favCategory);
        }

        // Set view type
        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-toggle .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            render();
        }

        // Render main view
        function render() {
            renderCategories();
            updateStats();
            
            // Create mini charts after DOM is updated
            requestAnimationFrame(() => {
                Object.values(categories).flat().forEach(item => {
                    // Add small delay to ensure DOM elements exist
                    setTimeout(() => createMiniChart(item.symbol), 50);
                });
                
                // Re-setup chart interactivity after charts are created
                setTimeout(setupChartInteractivity, 300);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                searchQuery = e.target.value;
                render();
            });

            // Initialize data
            initializeData();
            
            // Initial render and price update
            render();
            updateAllPrices();

            // Start auto-update
            updateInterval = setInterval(updateAllPrices, UPDATE_INTERVAL);
            
            // Start background updates
            setTimeout(startBackgroundUpdates, 2000);
            
            // Add click event delegation for better performance
            document.addEventListener('click', (e) => {
                const card = e.target.closest('.item-card');
                if (card && e.target.closest('.clickable-overlay')) {
                    const symbol = card.dataset.symbol;
                    if (symbol) {
                        showDetails(symbol);
                    }
                }
            });
        });

        // Setup chart hover interactivity - simplified for Chart.js
        function setupChartInteractivity() {
            // Chart.js handles interactivity natively, no additional setup needed
            console.log('Chart interactivity setup completed');
        }

        // Background update system
        let isPageVisible = true;
        let backgroundUpdateInterval;

        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            isPageVisible = !document.hidden;
            
            if (!isPageVisible) {
                // Page is hidden - start background updates
                startBackgroundUpdates();
                updateBackgroundIndicator(true);
            } else {
                // Page is visible - stop background updates and use normal updates
                stopBackgroundUpdates();
                updateBackgroundIndicator(false);
                // Update immediately when page becomes visible
                updateAllPrices();
                
                // Show notification if data was collected in background
                const lastUpdate = localStorage.getItem('lastBackgroundUpdate');
                if (lastUpdate) {
                    const timeDiff = Date.now() - parseInt(lastUpdate);
                    if (timeDiff < UPDATE_INTERVAL * 2) {
                        showNotification('Data collected while you were away!');
                    }
                    localStorage.removeItem('lastBackgroundUpdate');
                }
            }
        });

        // Update background indicator
        function updateBackgroundIndicator(isActive) {
            const indicator = document.getElementById('bgIndicator');
            if (indicator) {
                if (isActive) {
                    indicator.classList.remove('inactive');
                    indicator.innerHTML = `
                        <span style="width: 6px; height: 6px; background: currentColor; border-radius: 50%; display: inline-block;"></span>
                        Background Collection Active
                    `;
                } else {
                    indicator.classList.add('inactive');
                    indicator.innerHTML = `
                        <span style="width: 6px; height: 6px; background: currentColor; border-radius: 50%; display: inline-block;"></span>
                        Tab Active - Collecting Data
                    `;
                }
            }
        }

        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #1a1a2e;
                border: 1px solid #00ff88;
                padding: 15px 25px;
                border-radius: 10px;
                color: #00ff88;
                font-size: 0.9rem;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Start background updates
        function startBackgroundUpdates() {
            // Starting background updates
            
            // Continue updates even when page is hidden
            if (!backgroundUpdateInterval) {
                backgroundUpdateInterval = setInterval(() => {
                    if (!isPageVisible) {
                        // Simple price updates without UI rendering
                        Object.values(categories).flat().forEach(item => {
                            updateItemPrice(item);
                        });
                        saveData();
                        // Background update completed
                    }
                }, UPDATE_INTERVAL);
            }
        }

        // Stop background updates
        function stopBackgroundUpdates() {
            // Stopping background updates
            if (backgroundUpdateInterval) {
                clearInterval(backgroundUpdateInterval);
                backgroundUpdateInterval = null;
            }
        }

        // Force refresh all charts
        function refreshAllCharts() {
            Object.values(categories).flat().forEach(item => {
                // Destroy existing chart if it exists
                if (miniCharts[item.symbol]) {
                    miniCharts[item.symbol].destroy();
                    delete miniCharts[item.symbol];
                }
                
                // Recreate chart
                setTimeout(() => createMiniChart(item.symbol), 100);
            });
        }

        // Enhanced update all prices for background compatibility - ASYNC VERSION  
        async function updateAllPrices() {
            // Update all items in parallel for efficiency
            const updatePromises = Object.values(categories).flat().map(item => updateItemPrice(item));
            
            let realDataCount = 0;
            let totalItems = Object.values(categories).flat().length;
            
            try {
                await Promise.all(updatePromises);
                
                // Check how many items have real data vs simulated
                Object.values(categories).flat().forEach(item => {
                    const priceElement = document.getElementById(`price-${item.symbol}`);
                    if (priceElement && priceElement.title && priceElement.title.includes('Real market data')) {
                        realDataCount++;
                    }
                });
                
                // Update data source indicator
                updateDataSourceIndicator(realDataCount, totalItems);
                
                console.log(`✅ Price update completed - ${realDataCount}/${totalItems} using real market data`);
            } catch (error) {
                console.warn('⚠️ Some price updates failed:', error.message);
                updateDataSourceIndicator(0, totalItems);
            }
            
            // Only update UI if page is visible
            if (isPageVisible) {
                document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
                updateStats();
                
                // Update existing elements without full re-render
                Object.values(categories).flat().forEach(item => {
                    const priceElement = document.getElementById(`price-${item.symbol}`);
                    const changeElement = document.getElementById(`change-${item.symbol}`);
                    const highElement = document.getElementById(`high-${item.symbol}`);
                    const lowElement = document.getElementById(`low-${item.symbol}`);
                    
                    if (priceElement) {
                        const price = currentPrices[item.symbol];
                        const dataWeek = getHistoricalData(item.symbol, '1W');
                        const stats = calculateStats(dataWeek);
                        
                        priceElement.textContent = `${formatPrice(price)}${item.unit}`;
                        
                        if (changeElement) {
                            changeElement.textContent = `${stats.changePercent >= 0 ? '▲' : '▼'} ${Math.abs(stats.changePercent).toFixed(2)}%`;
                            changeElement.className = `price-change ${stats.changePercent >= 0 ? 'positive' : 'negative'}`;
                        }
                        
                        if (highElement) highElement.textContent = formatPrice(stats.high || price);
                        if (lowElement) lowElement.textContent = formatPrice(stats.low || price);
                        
                        // Update mini chart
                        setTimeout(() => createMiniChart(item.symbol), 50);
                    }
                });
            }
            
            saveData();
            
            // Background data collection is active when page is not visible
        }
        
        // Update data source indicator based on real vs simulated data
        function updateDataSourceIndicator(realDataCount, totalItems) {
            const indicator = document.getElementById('dataSourceIndicator');
            if (!indicator) return;
            
            const realDataPercentage = (realDataCount / totalItems) * 100;
            
            if (realDataPercentage >= 80) {
                // Mostly real data
                indicator.style.background = 'rgba(0, 255, 136, 0.1)';
                indicator.style.borderColor = 'rgba(0, 255, 136, 0.3)';
                indicator.style.color = '#00ff88';
                indicator.innerHTML = `
                    <span style="width: 6px; height: 6px; background: currentColor; border-radius: 50%; display: inline-block;"></span>
                    Real Market Data (${realDataCount}/${totalItems})
                `;
            } else if (realDataPercentage >= 30) {
                // Mixed data
                indicator.style.background = 'rgba(255, 165, 0, 0.1)';
                indicator.style.borderColor = 'rgba(255, 165, 0, 0.3)';
                indicator.style.color = '#ffa500';
                indicator.innerHTML = `
                    <span style="width: 6px; height: 6px; background: currentColor; border-radius: 50%; display: inline-block;"></span>
                    Mixed Data (${realDataCount}/${totalItems} real)
                `;
            } else {
                // Mostly simulated data
                indicator.style.background = 'rgba(255, 77, 77, 0.1)';
                indicator.style.borderColor = 'rgba(255, 77, 77, 0.3)';
                indicator.style.color = '#ff4d4d';
                indicator.innerHTML = `
                    <span style="width: 6px; height: 6px; background: currentColor; border-radius: 50%; display: inline-block;"></span>
                    Simulated Data (${realDataCount}/${totalItems} real)
                `;
            }
        }

        // Prevent page unload if data is being collected
        window.addEventListener('beforeunload', (e) => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            if (backgroundUpdateInterval) {
                clearInterval(backgroundUpdateInterval);
            }
            saveData();
            
            // Get total data points
            const totalPoints = Object.values(historicalData).reduce((sum, data) => sum + data.length, 0);
            
            // Warn user if they have significant data
            if (totalPoints > 100) {
                e.preventDefault();
                e.returnValue = 'You have collected ' + totalPoints + ' data points. Are you sure you want to leave?';
            }
        });

        // Debug function for troubleshooting
        function debugCharts() {
            console.log('=== Chart Debug Info ===');
            console.log('Mini charts created:', Object.keys(miniCharts).length);
            console.log('Canvas elements found:', document.querySelectorAll('canvas').length);
            console.log('Chart containers found:', document.querySelectorAll('.chart-mini').length);
            
            Object.values(categories).flat().forEach(item => {
                const canvas = document.getElementById(`miniChart-${item.symbol}`);
                const container = document.getElementById(`chart-${item.symbol}`);
                console.log(`${item.symbol}: canvas=${!!canvas}, container=${!!container}, chart=${!!miniCharts[item.symbol]}`);
            });
        }

        // Add debug to window for console access
        window.debugCharts = debugCharts;
        window.refreshAllCharts = refreshAllCharts;

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                manualRefresh();
            }
            // Debug shortcut
            if (e.key === 'd' && e.ctrlKey && e.shiftKey) {
                e.preventDefault();
                debugCharts();
            }
        });
        
        // Add test script in development
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            // Simple UI test script for the price tracker
            console.log('🧪 Starting UI tests...');

            // Test after initial load
            setTimeout(() => {
                console.log('✅ Page loaded');
                
                // Test cards
                const cards = document.querySelectorAll('.item-card');
                console.log(`📊 Found ${cards.length} cards`);
                
                // Test charts
                const canvases = document.querySelectorAll('canvas');
                console.log(`📈 Found ${canvases.length} canvas elements`);
                
                // Test overlays
                const overlays = document.querySelectorAll('.clickable-overlay');
                console.log(`🖱️ Found ${overlays.length} clickable overlays`);
                
                // Test chart creation
                console.log(`📊 Mini charts created: ${Object.keys(miniCharts).length}`);
                
                console.log('🏁 UI tests completed');
            }, 3000);
        }
    </script>
</body>
</html>